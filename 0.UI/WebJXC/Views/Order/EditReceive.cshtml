@{
    ViewBag.Title = "EditReceive";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<form id="mainform" method="post" style="height: 310px">
    <input type="hidden" name="DetailGrid" id="HDetailData" value="" />
</form>
<div id="detailGrid">
</div>
<script type="text/javascript">
    //全局对象
    var detailGrid = null;
    var ReceiveID = "@ViewData["id"]";

    $.when($.get("/config/Columns/AccountReceivableMaster")).done(function (c1) {

        var config = LG.bulidData(c1);
        var form = $("#mainform").ligerForm({ fields: config.form });


        var option = {
            columns: [
                        { display: '出货单号', name: 'DeliveryID', width: 80, align: 'right' },
                        { display: '应收金额', name: 'AccountReceivable', width: 80, align: 'right', type: 'currency' },
                        {
                            display: '金额', name: 'Balance', width: 100, align: 'right', editor: { type: 'float', isNegative: false }, type: 'currency',
                            totalSummary: {
                                type: "sum"
                            }
                        }
            ],
            toolbar: getToolbar(),
            enabledEdit: true,
            width: '98%', heightDiff: -10,
            usePager: false
        };

        detailGrid = $("#detailGrid").ligerGrid(option);

        if (ReceiveID) {
            LG.ajax({
                url: "/order/GetReceiveById", data: { ReceiveID: ReceiveID }, success: function (data) {
                    LG.loadForm($("#mainform"), data[0]);
                }
            });
            LG.ajax({
                url: "/order/GetReceiveDetail", data: { ReceiveID: ReceiveID }, success: function (data) {
                    detailGrid.loadData({ Rows: data });
                }
            });
        }
        else {
            LG.ajax({
                url: "/order/GetNewReceiveId", success: function (data) {
                    LG.loadForm($("#mainform"), data);
                }
            });
        }

        //var tab = $("#tabcontainer").ligerTab();
    });

    function save(dialog) {
        if (detailGrid) {
            //保存订单明细 表格的JSON  后台(AjaxOrderManage.AddOrders或UpdateOrders)可接收
            $("#HDetailData").val(JSON2.stringify(detailGrid.getData()));
        }
        if (ReceiveID) {
            $("#mainform").attr("action", "/order/editReceive");
        }
        else {
            $("#mainform").attr("action", "/order/addReceive");
        }
        LG.submitForm($("#mainform"), function (data) {
            if (!data.IsError) {
                if (data.Message == "收款等于应收") {
                    dialog.hidden();
                    return;
                }
                $.ligerDialog.confirm(data.Message, function (yes) {
                    if (yes) {
                        dialog.hidden();
                    }
                    else {
                        ReceiveID = $("#ReceiveID").val();
                    }
                });
            }
            else { LG.showError(data.Message); }
        });
    }



    function getToolbar() {
        var o = {
            text: '引入',
            img: '/content/icons/32X32/import.png'
        };
        o.click = function () {
            LG.showSelect("/config/Columns/DeliveryMaster", '/order/getDelivery?noReceived=true', select, true);
        };

        var itemDel = {
            text: '删除',
            img: '/content/icons/silkicons/delete.png'
        };
        itemDel.click = function () {
            if (detailGrid.getSelected()) {
                detailGrid.remove(detailGrid.getSelected());
            }
            else {
                LG.tip("请选择!");
            }

        };

        return { items: [o, itemDel] };

    }

    function select(checked) {
        $(checked).each(function () {
            if (exist(this.DeliveryID)) return;

            // ligerGrid _addData bug fixed
            if (!detailGrid.currentData.Rows)
                detailGrid.currentData.Rows = [];

            detailGrid.addRow({
                DeliveryID: this.DeliveryID,
                AccountReceivable: this.AccountReceivable,
                Balance: this.AccountReceivable
            });
        });
    }

    function exist(DeliveryID) {
        var rows = detailGrid.rows;
        for (var i = 0, l = rows.length; i < l; i++) {
            var o = rows[i];
            if (o.DeliveryID == DeliveryID) return true;
        }
        return false;
    }

</script>
